<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestion des Parcellaires – Pikine Nord</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <style>
    /* ─── RESET ─── */
    *, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }
    html, body { height:100%; font-family:'Segoe UI',sans-serif; overflow:hidden; }

    /* ─── HEADER ─── */
    .header {
      position:fixed; top:0; left:0; right:0; height:56px; z-index:1100;
      background:linear-gradient(135deg, #c2185b, #e91e63);
      color:#fff; display:flex; align-items:center; justify-content:space-between;
      padding:0 20px; box-shadow:0 3px 14px rgba(0,0,0,.3);
    }
    .hdr-left { display:flex; align-items:center; gap:12px; }
    .hdr-logo {
      width:38px; height:38px; background:#fff; border-radius:9px;
      display:flex; align-items:center; justify-content:center;
      color:#c2185b; font-size:18px;
    }
    .hdr-title { font-size:18px; font-weight:700; line-height:1.2; }
    .hdr-title small { display:block; font-size:11px; opacity:.78; font-weight:400; }
    .hdr-nav { display:flex; gap:5px; }
    .hdr-btn {
      background:rgba(255,255,255,.17); border:none; color:#fff;
      padding:6px 14px; border-radius:18px; cursor:pointer;
      font-size:12.5px; display:flex; align-items:center; gap:5px; transition:.2s;
    }
    .hdr-btn:hover, .hdr-btn.active { background:rgba(255,255,255,.32); }

    /* ─── LAYOUT ─── */
    .layout { display:flex; height:100%; padding-top:56px; }

    /* ─── SIDEBAR ─── */
    .sidebar {
      width:310px; background:#f5f6f8; height:100%; overflow-y:auto;
      box-shadow:3px 0 10px rgba(0,0,0,.1); flex-shrink:0;
      display:flex; flex-direction:column;
    }
    .sb-head {
      background:linear-gradient(135deg, #c2185b, #e91e63);
      color:#fff; padding:12px 16px; font-size:14px; font-weight:600;
      display:flex; align-items:center; gap:8px;
      position:sticky; top:0; z-index:5;
    }
    .sb-body { padding:12px; display:flex; flex-direction:column; gap:12px; }

    /* search */
    .search-wrap { position:relative; }
    .search-wrap input {
      width:100%; padding:9px 34px 9px 13px; border:2px solid #e0e0e0;
      border-radius:20px; font-size:13px; outline:none; background:#fff; transition:.2s;
    }
    .search-wrap input:focus { border-color:#e91e63; }
    .search-wrap i { position:absolute; right:13px; top:50%; transform:translateY(-50%); color:#aaa; font-size:14px; }

    /* stats */
    .stats { display:grid; grid-template-columns:1fr 1fr; gap:9px; }
    .stat {
      padding:13px 4px; border-radius:12px; text-align:center; color:#fff;
      box-shadow:0 3px 8px rgba(0,0,0,.13); transition:transform .2s;
    }
    .stat:hover { transform:translateY(-2px); }
    .s1 { background:linear-gradient(135deg,#667eea,#764ba2); }
    .s2 { background:linear-gradient(135deg,#f093fb,#f5576c); }
    .s3 { background:linear-gradient(135deg,#4facfe,#00f2fe); }
    .s4 { background:linear-gradient(135deg,#43e97b,#38f9d7); }
    .stat-num { font-size:25px; font-weight:700; }
    .stat-lbl { font-size:11px; opacity:.9; margin-top:2px; }

    /* panels */
    .panel { background:#fff; border-radius:10px; padding:11px 13px; border:1px solid #eee; }
    .panel h4 { color:#c2185b; font-size:13px; font-weight:600; margin-bottom:8px; display:flex; align-items:center; gap:6px; }

    /* legend rows */
    .leg-row { display:flex; align-items:center; gap:8px; font-size:13px; color:#444; margin-bottom:5px; }
    .leg-sw { width:20px; height:13px; border-radius:3px; flex-shrink:0; }
    .sw-parcelle { background:#e91e63; }
    .sw-batiment { background:#ff6b35; }
    .sw-zone { background:rgba(100,140,255,.22); border:2px dashed #648cff; }

    /* couche toggles */
    .layer-row { display:flex; align-items:center; justify-content:space-between; font-size:13px; color:#444; margin-bottom:5px; }
    .layer-row label { display:flex; align-items:center; gap:7px; }
    .tog { position:relative; width:36px; height:21px; }
    .tog input { opacity:0; width:0; height:0; }
    .tog .sl {
      position:absolute; inset:0; background:#ccc; border-radius:21px;
      transition:.25s; cursor:pointer;
    }
    .tog .sl::before {
      content:''; position:absolute; height:15px; width:15px;
      left:3px; bottom:3px; background:#fff; border-radius:50%; transition:.25s;
    }
    .tog input:checked + .sl { background:#e91e63; }
    .tog input:checked + .sl::before { transform:translateX(15px); }

    /* parcelle list */
    .list-hd { font-size:11px; color:#999; text-transform:uppercase; letter-spacing:.5px; font-weight:600; }
    .plist { display:flex; flex-direction:column; gap:5px; max-height:230px; overflow-y:auto; padding-right:3px; }
    .plist::-webkit-scrollbar { width:4px; }
    .plist::-webkit-scrollbar-thumb { background:#ddd; border-radius:2px; }
    .p-card {
      background:#fff; border:1px solid #eee; border-left:4px solid #e91e63;
      border-radius:8px; padding:9px 11px; cursor:pointer; transition:.2s;
    }
    .p-card:hover { box-shadow:0 2px 8px rgba(0,0,0,.12); transform:translateX(3px); border-color:#e91e63; }
    .p-card h5 { font-size:13px; color:#c2185b; margin-bottom:2px; }
    .p-card p { font-size:11.5px; color:#666; margin:1.5px 0; }

    /* ─── MAP ─── */
    #map { flex:1; height:100%; }
    .leaflet-control-zoom { display:none; }

    /* custom controls */
    .map-ctrl {
      position:absolute; top:10px; right:10px; z-index:1000;
      display:flex; flex-direction:column; gap:5px;
    }
    .mc {
      width:33px; height:33px; background:#fff; border:none; border-radius:7px;
      box-shadow:0 2px 6px rgba(0,0,0,.2); cursor:pointer;
      display:flex; align-items:center; justify-content:center;
      font-size:14px; color:#444; transition:.2s;
    }
    .mc:hover { background:#f0f0f0; box-shadow:0 3px 9px rgba(0,0,0,.25); }

    /* badge */
    .zone-badge {
      position:absolute; bottom:26px; left:50%; transform:translateX(-50%);
      z-index:1000; background:rgba(194,24,91,.87); color:#fff;
      padding:5px 15px; border-radius:17px; font-size:12.5px; font-weight:600;
      box-shadow:0 2px 8px rgba(0,0,0,.25); pointer-events:none;
      display:flex; align-items:center; gap:6px;
    }

    /* ─── POPUP ─── */
    .pop h4 { color:#c2185b; font-size:14px; margin-bottom:6px; padding-bottom:5px; border-bottom:1px solid #f0f0f0; }
    .pop table { width:100%; border-collapse:collapse; font-size:12.5px; }
    .pop table td { padding:3px 0; color:#555; vertical-align:top; }
    .pop table td:first-child { font-weight:600; color:#333; width:85px; }

    /* ─── MODAL ─── */
    .overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:2000; justify-content:center; align-items:center; }
    .overlay.show { display:flex; }
    .modal {
      background:#fff; border-radius:13px; padding:24px; width:92%; max-width:440px;
      max-height:86vh; overflow-y:auto; box-shadow:0 14px 40px rgba(0,0,0,.3);
    }
    .modal-hd { display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; }
    .modal-hd h2 { color:#c2185b; font-size:18px; }
    .modal-hd .xbtn { background:none; border:none; font-size:23px; cursor:pointer; color:#aaa; }
    .modal-hd .xbtn:hover { color:#333; }
    .fg { margin-bottom:12px; }
    .fg label { display:block; font-size:12.5px; font-weight:600; color:#444; margin-bottom:4px; }
    .fg input, .fg textarea {
      width:100%; padding:9px 10px; border:2px solid #e0e0e0; border-radius:7px;
      font-size:13px; outline:none; transition:.2s;
    }
    .fg input:focus, .fg textarea:focus { border-color:#e91e63; }
    .fg-row { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    .btn-save {
      width:100%; padding:10px; background:linear-gradient(135deg,#c2185b,#e91e63);
      color:#fff; border:none; border-radius:20px; font-size:14px; font-weight:600;
      cursor:pointer; transition:transform .2s;
    }
    .btn-save:hover { transform:translateY(-2px); box-shadow:0 4px 12px rgba(194,24,91,.4); }

    /* about table */
    .about-tbl { width:100%; border-collapse:collapse; font-size:13.5px; margin-top:10px; }
    .about-tbl td { padding:5px 0; color:#555; }
    .about-tbl td:first-child { font-weight:600; color:#333; width:130px; }
    .about-tbl .sep { color:#c2185b; font-weight:600; padding-top:12px !important; border-top:1px solid #eee; }

    /* FAB */
    .fab {
      position:fixed; bottom:20px; right:20px; width:48px; height:48px;
      background:linear-gradient(135deg,#c2185b,#e91e63); border:none; border-radius:50%;
      color:#fff; font-size:20px; cursor:pointer; z-index:1500;
      box-shadow:0 4px 14px rgba(194,24,91,.5); transition:transform .2s;
      display:flex; align-items:center; justify-content:center;
    }
    .fab:hover { transform:scale(1.1); }

    @media(max-width:680px){
      .layout { flex-direction:column; }
      .sidebar { width:100%; max-height:250px; }
      .hdr-nav { display:none; }
    }
  </style>
</head>
<body>

<!-- ══ HEADER ══ -->
<div class="header">
  <div class="hdr-left">
    <div class="hdr-logo"><i class="fas fa-map-marked-alt"></i></div>
    <div class="hdr-title">Gestion des Parcellaires dans la commune de Pikine Nord
      <small>Commune de Pikine Nord · Département de Pikine · Région de Dakar</small>
    </div>
  </div>
  <div class="hdr-nav">
    <button class="hdr-btn active"><i class="fas fa-home"></i> Accueil</button>
    <button class="hdr-btn" onclick="document.getElementById('aboutOverlay').classList.add('show')"><i class="fas fa-info-circle"></i> À propos</button>
    <button class="hdr-btn" onclick="document.getElementById('catalogOverlay').classList.add('show')"><i class="fas fa-th"></i> Catalogue</button>
    <button class="hdr-btn" onclick="exportGeoJSON()"><i class="fas fa-download"></i> Télécharger</button>
  </div>
</div>

<!-- ══ LAYOUT ══ -->
<div class="layout">

  <!-- SIDEBAR -->
  <div class="sidebar">
    <div class="sb-head"><i class="fas fa-layer-group"></i> Panneau de Contrôle</div>
    <div class="sb-body">

      <!-- recherche -->
      <div class="search-wrap">
        <input type="text" id="searchInput" placeholder="Rechercher un lieu…" oninput="filterList()">
        <i class="fas fa-search"></i>
      </div>

      <!-- statistiques -->
      <div class="stats">
        <div class="stat s1"><div class="stat-num">3 654</div><div class="stat-lbl">Total</div></div>
        <div class="stat s2"><div class="stat-num">3 544</div><div class="stat-lbl">Lots</div></div>
        <div class="stat s3"><div class="stat-num" id="stParcelles">—</div><div class="stat-lbl">Parcelles</div></div>
        <div class="stat s4"><div class="stat-num">004</div><div class="stat-lbl">Section</div></div>
      </div>

      <!-- légende -->
      <div class="panel">
        <h4><i class="fas fa-palette"></i> Légende</h4>
        <div class="leg-row"><div class="leg-sw sw-parcelle"></div> Parcelles</div>
        <div class="leg-row"><div class="leg-sw sw-batiment"></div> Bâtiments</div>
        <div class="leg-row"><div class="leg-sw sw-zone"></div> Zone d'étude (Commune)</div>
      </div>

      <!-- gestion couches -->
      <div class="panel">
        <h4><i class="fas fa-layer-group"></i> Gestion des couches</h4>
        <div class="layer-row">
          <label><div class="leg-sw sw-parcelle"></div> Parcellaire</label>
          <label class="tog"><input type="checkbox" checked onchange="toggleCouche('parcellaire',this.checked)"><span class="sl"></span></label>
        </div>
        <div class="layer-row">
          <label><div class="leg-sw sw-batiment"></div> Bâtiments</label>
          <label class="tog"><input type="checkbox" checked onchange="toggleCouche('batiment',this.checked)"><span class="sl"></span></label>
        </div>
        <div class="layer-row">
          <label><div class="leg-sw sw-zone"></div> Zone d'étude</label>
          <label class="tog"><input type="checkbox" checked onchange="toggleCouche('zone',this.checked)"><span class="sl"></span></label>
        </div>
      </div>

      <!-- liste parcelles -->
      <div class="list-hd"><i class="fas fa-list"></i> Liste des parcelles</div>
      <div class="plist" id="plist"><p style="color:#aaa;font-size:13px;">Chargement…</p></div>

    </div>
  </div>

  <!-- MAP -->
  <div id="map" style="position:relative;">
    <div class="map-ctrl">
      <button class="mc" onclick="map.zoomIn()" title="Zoom +"><i class="fas fa-plus"></i></button>
      <button class="mc" onclick="map.zoomOut()" title="Zoom −"><i class="fas fa-minus"></i></button>
      <button class="mc" onclick="resetView()" title="Vue initiale"><i class="fas fa-crosshairs"></i></button>
      <button class="mc" onclick="toggleSat()" title="Satellite"><i class="fas fa-satellite"></i></button>
    </div>
    <div class="zone-badge"><i class="fas fa-map"></i> Zone d'étude – Commune de Pikine Nord</div>
  </div>
</div>

<!-- FAB -->
<button class="fab" onclick="openAdd()" title="Ajouter une parcelle"><i class="fas fa-plus"></i></button>

<!-- ══ MODAL AJOUT ══ -->
<div class="overlay" id="addOverlay">
  <div class="modal">
    <div class="modal-hd"><h2>Ajouter une parcelle</h2><button class="xbtn" onclick="document.getElementById('addOverlay').classList.remove('show')">&times;</button></div>
    <div class="fg"><label>NICAD *</label><input type="text" id="fNicad" placeholder="Ex : 14 1 004 01 04432"></div>
    <div class="fg-row">
      <div class="fg"><label>N° Lot *</label><input type="text" id="fLot" placeholder="Ex : 4432"></div>
      <div class="fg"><label>Section</label><input type="text" value="004" readonly></div>
    </div>
    <div class="fg"><label>Commune</label><input type="text" value="Pikine Nord" readonly></div>
    <div class="fg"><label>Propriétaire</label><input type="text" id="fProp" placeholder="Nom…"></div>
    <div class="fg-row">
      <div class="fg"><label>Latitude</label><input type="number" id="fLat" step="0.000001" placeholder="14.7646"></div>
      <div class="fg"><label>Longitude</label><input type="number" id="fLng" step="0.000001" placeholder="-17.3674"></div>
    </div>
    <div class="fg"><label>Observations</label><textarea id="fObs" rows="2" placeholder="Remarques…"></textarea></div>
    <button class="btn-save" onclick="saveAdd()"><i class="fas fa-save"></i> Enregistrer</button>
  </div>
</div>

<!-- ══ MODAL À PROPOS ══ -->
<div class="overlay" id="aboutOverlay">
  <div class="modal">
    <div class="modal-hd"><h2>À propos</h2><button class="xbtn" onclick="document.getElementById('aboutOverlay').classList.remove('show')">&times;</button></div>
    <p style="font-size:13.5px;color:#555;line-height:1.7;">Cette plateforme a été développée pour la <strong>gestion foncière de la commune de Pikine Nord</strong>, située dans le département de Pikine, région de Dakar, Sénégal.</p>
    <table class="about-tbl">
      <tr><td>Commune</td><td>Pikine Nord</td></tr>
      <tr><td>Département</td><td>Pikine</td></tr>
      <tr><td>Région</td><td>Dakar</td></tr>
      <tr><td>Superficie</td><td>≈ 1,006 km²</td></tr>
      <tr><td>Section</td><td>004</td></tr>
      <tr><td>Total Parcelles</td><td id="aboutParcelles">—</td></tr>
      <tr><td>Total Lots</td><td id="aboutLots">—</td></tr>
    </table>
  </div>
</div>

<!-- ══ MODAL CATALOGUE ══ -->
<div class="overlay" id="catalogOverlay">
  <div class="modal">
    <div class="modal-hd"><h2>Catalogue des données</h2><button class="xbtn" onclick="document.getElementById('catalogOverlay').classList.remove('show')">&times;</button></div>
    <table class="about-tbl">
      <tr><td class="sep" colspan="2">Couches disponibles</td></tr>
      <tr><td>Parcellaire</td><td>parcellaire_pikine_nord.geojson</td></tr>
      <tr><td>Bâtiments</td><td>Batiment_pikine_Nord.geojson</td></tr>
      <tr><td>Zone d'étude</td><td>pikine_nord.geojson</td></tr>
      <tr><td class="sep" colspan="2">Informations</td></tr>
      <tr><td>Format</td><td>GeoJSON</td></tr>
      <tr><td>Source</td><td>Service du Cadastre – Pikine Nord</td></tr>
      <tr><td>Mise à jour</td><td>Février 2026</td></tr>
    </table>
  </div>
</div>

<!-- ══ SCRIPTS ══ -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
/* ═══ CARTE ═══ */
const OSM = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ attribution:'© OpenStreetMap contributors', maxZoom:19 });
const SAT = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{ attribution:'© Esri', maxZoom:18 });
const map = L.map('map',{ zoomControl:false }).setView([14.75,-17.40],13);
OSM.addTo(map);
let satOn = false;
function toggleSat(){ satOn?(map.removeLayer(SAT),OSM.addTo(map)):(map.removeLayer(OSM),SAT.addTo(map)); satOn=!satOn; }

/* ═══ COUCHES (référence) ═══ */
let lZone = null, lParcellaire = null, lBatiment = null;
let zoneBounds = null;
function resetView(){ zoneBounds && map.fitBounds(zoneBounds); }

/* ═══ DONNÉES en mémoire ═══ */
let allItems = [];            // { feature, layer }
let filteredItems = [];       // après filtrage

/* ═══ 1 – ZONE D'ÉTUDE ═══ */
// Polygone de la commune de Pikine Nord (coordonnées réelles)
const ZONE_COORDS = [
  [14.7530, -17.4120],[14.7545, -17.4080],[14.7560, -17.4040],
  [14.7580, -17.4000],[14.7600, -17.3960],[14.7620, -17.3930],
  [14.7640, -17.3900],[14.7660, -17.3880],[14.7680, -17.3870],
  [14.7700, -17.3875],[14.7715, -17.3890],[14.7725, -17.3910],
  [14.7730, -17.3940],[14.7728, -17.3975],[14.7720, -17.4010],
  [14.7705, -17.4045],[14.7685, -17.4075],[14.7665, -17.4095],
  [14.7645, -17.4110],[14.7625, -17.4118],[14.7605, -17.4120],
  [14.7585, -17.4118],[14.7565, -17.4112],[14.7545, -17.4120],
  [14.7530, -17.4120]
];

function creerZone(coords){
  lZone = L.polygon(coords, {
    color:'#648cff', weight:3, dashArray:'10 6',
    fillColor:'#648cff', fillOpacity:0.1
  }).addTo(map);
  zoneBounds = lZone.getBounds();
  map.fitBounds(zoneBounds);
}

// Essayer le fichier GeoJSON d'abord ; si ça échoue → utiliser le polygone hardcodé
fetch('data/pikine_nord.geojson')
  .then(r=>{ if(!r.ok) throw new Error(); return r.json(); })
  .then(geo=>{
    lZone = L.geoJSON(geo,{
      style:{ color:'#648cff', weight:3, dashArray:'10 6', fillColor:'#648cff', fillOpacity:0.1 }
    }).addTo(map);
    zoneBounds = lZone.getBounds();
    map.fitBounds(zoneBounds);
  })
  .catch(()=> creerZone(ZONE_COORDS));

/* ═══ 2 – PARCELLAIRE ═══ */
fetch('data/parcellaire_pikine_nord.geojson')
  .then(r=>{ if(!r.ok) throw new Error(); return r.json(); })
  .then(geo=>{
    lParcellaire = L.geoJSON(geo,{
      style:{ color:'#e91e63', weight:1.2, fillColor:'#e91e63', fillOpacity:0.3 },
      onEachFeature(feature, layer){
        allItems.push({ feature, layer });
        layer.on('click', e=>{ e.stopPropagation(); openPopup(feature, layer); });
      }
    }).addTo(map);
    refreshSidebar();
  })
  .catch(()=>{ console.warn('parcellaire_pikine_nord.geojson introuvable'); refreshSidebar(); });

/* ═══ 3 – BÂTIMENTS ═══ */
fetch('data/Batiment_pikine_Nord.geojson')
  .then(r=>{ if(!r.ok) throw new Error(); return r.json(); })
  .then(geo=>{
    lBatiment = L.geoJSON(geo,{
      style:{ color:'#ff6b35', weight:1, fillColor:'#ff6b35', fillOpacity:0.5 }
    }).addTo(map);
  })
  .catch(()=>console.warn('Batiment_pikine_Nord.geojson introuvable'));

/* ═══ TOGGLE couches ═══ */
function toggleCouche(name, on){
  const tgt = name==='parcellaire'?lParcellaire : name==='batiment'?lBatiment : lZone;
  if(!tgt) return;
  on ? tgt.addTo(map) : map.removeLayer(tgt);
}

/* ═══ POPUP ═══ */
function openPopup(feature, layer){
  const p = feature.properties || {};
  // on teste les noms de champs les plus courants dans les GeoJSON cadastraux sénégalais
  const nicad = p.nicad || p.NICAD || p.Nicad || '—';
  const lot   = p.num_lot || p.NumLot || p.numero_lot || p.Lot || '—';
  const sect  = p.num_sect || p.section || p.Section || '004';
  const comm  = p.nom_commune || p.commune || p.Commune || 'Pikine Nord';
  const prop  = p.proprietaire || p.Proprietaire || '—';
  const obs   = p.observations || p.Observations || '';

  const html = `<div class="pop">
    <h4><i class="fas fa-map-marker-alt" style="color:#e91e63"></i>&nbsp; Lot – ${lot}</h4>
    <table>
      <tr><td>NICAD</td><td>${nicad}</td></tr>
      <tr><td>N° Lot</td><td>${lot}</td></tr>
      <tr><td>Section</td><td>${sect}</td></tr>
      <tr><td>Commune</td><td>${comm}</td></tr>
      <tr><td>Propriétaire</td><td>${prop}</td></tr>
      ${obs?'<tr><td>Obs</td><td>'+obs+'</td></tr>':''}
    </table>
  </div>`;
  layer.bindPopup(html,{ maxWidth:260 }).openPopup();
}

/* ═══ SIDEBAR – stats + liste ═══ */
function refreshSidebar(){
  // Total et Lots sont déjà hardcodés (3 654 / 3 544), Section = 004
  // On met à jour uniquement Parcelles (chargées depuis le GeoJSON)
  document.getElementById('stParcelles').textContent = allItems.length.toLocaleString();
  // À propos
  document.getElementById('aboutParcelles').textContent = '3 654';
  document.getElementById('aboutLots').textContent      = '3 544';

  renderList();
}

/* ═══ LISTE sidebar ═══ */
function renderList(filter=''){
  const f = filter.toLowerCase();
  filteredItems = allItems.filter(i=>{
    const p = i.feature.properties || {};
    return [p.nicad,p.NICAD,p.num_lot,p.NumLot,p.numero_lot,p.nom_commune,p.commune,p.proprietaire,p.Proprietaire]
      .map(v=>(v||'').toString().toLowerCase()).some(v=>v.includes(f));
  });

  // limiter à 100 cartes pour la perfo
  const show = filteredItems.slice(0,100);
  const el = document.getElementById('plist');
  el.innerHTML = show.map((item,idx)=>{
    const p = item.feature.properties || {};
    const lot  = p.num_lot || p.NumLot || p.numero_lot || p.Lot || '—';
    const nicad= p.nicad || p.NICAD || '—';
    const comm = p.nom_commune || p.commune || 'Pikine Nord';
    const prop = p.proprietaire || p.Proprietaire || 'Non attribué';
    return `<div class="p-card" onclick="zoomCard(${idx})">
      <h5>Lot ${lot} <small style="color:#999;font-weight:400">${nicad}</small></h5>
      <p><i class="fas fa-map-marker-alt"></i> ${comm}</p>
      <p><i class="fas fa-user"></i> ${prop}</p>
    </div>`;
  }).join('');

  if(filteredItems.length > 100)
    el.innerHTML += `<p style="text-align:center;color:#aaa;font-size:12px;padding:5px;">… et ${filteredItems.length-100} autres</p>`;
}

function filterList(){ renderList(document.getElementById('searchInput').value); }

function zoomCard(idx){
  const item = filteredItems[idx];
  if(!item) return;
  try {
    const b = item.layer.getBounds();
    if(b.isValid()){ map.fitBounds(b,{ maxZoom:18, padding:[50,50] }); }
  } catch(e){ /* marker sans bounds */ }
  setTimeout(()=> openPopup(item.feature, item.layer), 350);
}

/* ═══ MODAL AJOUT ═══ */
function openAdd(){ document.getElementById('addOverlay').classList.add('show'); }

function saveAdd(){
  const nicad = document.getElementById('fNicad').value.trim();
  const lot   = document.getElementById('fLot').value.trim();
  if(!nicad||!lot){ alert('NICAD et N° Lot sont obligatoires'); return; }

  const lat = parseFloat(document.getElementById('fLat').value);
  const lng = parseFloat(document.getElementById('fLng').value);

  const feature = {
    type:'Feature',
    geometry: (lat&&lng) ? { type:'Point', coordinates:[lng,lat] } : null,
    properties:{
      nicad, num_lot:lot, nom_commune:'Pikine Nord', num_sect:'004',
      proprietaire: document.getElementById('fProp').value.trim(),
      observations: document.getElementById('fObs').value.trim()
    }
  };

  let layer = null;
  if(feature.geometry){
    layer = L.marker([lat,lng]).addTo(map);
    layer.on('click', e=>{ e.stopPropagation(); openPopup(feature,layer); });
  }
  allItems.push({ feature, layer });
  refreshSidebar();
  document.getElementById('addOverlay').classList.remove('show');
  // vider les champs
  ['fNicad','fLot','fProp','fLat','fLng','fObs'].forEach(k=>document.getElementById(k).value='');
}

/* ═══ EXPORT ═══ */
function exportGeoJSON(){
  const fc = { type:'FeatureCollection', features: allItems.map(i=>i.feature) };
  const blob = new Blob([JSON.stringify(fc,null,2)],{type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'parcelles_pikine_nord_export.geojson';
  a.click();
}

/* ═══ FERMER overlays en cliquant dehors ═══ */
['addOverlay','aboutOverlay','catalogOverlay'].forEach(id=>{
  document.getElementById(id).addEventListener('click', function(e){ if(e.target===this) this.classList.remove('show'); });
});
</script>
</body>
</html>